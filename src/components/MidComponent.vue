<template>  <div ref="containerRef" class="rounded-lg shadow-lg" style="width: 100%;height: 100%; background: transparent;"></div></template><style scoped></style><script setup lang="ts">import { ref, type Ref, onMounted, reactive } from 'vue';import { get } from '../utils/request';import { useThree, THREEMAP } from './three-utils';import { CSS2DObject } from 'three/examples/jsm/renderers/CSS2DRenderer.js'import sy from '../assets/sy.jpg'import * as THREE from 'three'import maodian from '../assets/锚点 拷贝 15.png'import bj from '../assets/bj@2x.png'import modalBg from '../assets/dialog.png'const containerRef = ref<HTMLDivElement>() as Ref<HTMLDivElement>let modalImageSize = { width: 320, height: 180 }interface RegionData {  name: string  complaints: string  percentage: string}const defaultRegionData: Record<string, RegionData> = {  '康平县': { name: '康平县', complaints: '37485', percentage: '40.32' },  '法库县': { name: '法库县', complaints: '28756', percentage: '32.15' },  '新民市': { name: '新民市', complaints: '45123', percentage: '48.67' },  '辽中区': { name: '辽中区', complaints: '31245', percentage: '35.89' },  '于洪区': { name: '于洪区', complaints: '52341', percentage: '55.23' },  '沈北新区': { name: '沈北新区', complaints: '29876', percentage: '33.45' },  '大东区': { name: '大东区', complaints: '41567', percentage: '44.78' },  '和平区': { name: '和平区', complaints: '38945', percentage: '42.11' },  '苏家屯区': { name: '苏家屯区', complaints: '35678', percentage: '38.92' },  '浑南区': { name: '浑南区', complaints: '47892', percentage: '51.34' },  '沈河区': { name: '沈河区', complaints: '33456', percentage: '36.78' },  '皇姑区': { name: '皇姑区', complaints: '39234', percentage: '43.21' },  '铁西区': { name: '铁西区', complaints: '44567', percentage: '47.89' }}const regionDataMap = reactive<Record<string, RegionData>>({ ...defaultRegionData })const getRegionData = (regionName: string): RegionData => {  return regionDataMap[regionName] || { name: regionName, complaints: '0', percentage: '0' }}const fetchRegionData = async () => {  try {    const res = await get<RegionData[]>('/water/region-data')    if (Array.isArray(res)) {      res.forEach(item => {        regionDataMap[item.name] = { ...item }      })      refreshAllPopupContent()    }  } catch (err) {    console.error('获取区域数据失败: ', err)  }}const updatePopupPosition = () => { }const createPopupElement = (regionName: string): HTMLDivElement => {  const regionData = getRegionData(regionName)  const popupContainer = document.createElement('div')  popupContainer.style.position = 'relative'  popupContainer.style.width = `${modalImageSize.width}px`  popupContainer.style.height = `${modalImageSize.height}px`  popupContainer.style.backgroundImage = `url(${modalBg})`  popupContainer.style.backgroundSize = 'contain'  popupContainer.style.backgroundRepeat = 'no-repeat'  popupContainer.style.backgroundPosition = 'center'  popupContainer.style.filter = 'drop-shadow(0 0 15px rgba(0, 150, 255, 0.6))'  popupContainer.style.padding = '16px 20px'  popupContainer.style.color = 'white'  popupContainer.style.fontFamily = 'Arial, sans-serif'  popupContainer.style.pointerEvents = 'auto'  popupContainer.style.display = 'none'  popupContainer.style.flexDirection = 'column'  popupContainer.style.cursor = 'pointer'  popupContainer.addEventListener('click', (e) => {    e.stopPropagation()    console.log(`Popup clicked: ${regionName}`)  })  const titleArea = document.createElement('div')  titleArea.style.marginBottom = '16px'  titleArea.style.height = '30px'  const title = document.createElement('div')  title.textContent = regionData.name  title.style.fontSize = '19px'  title.style.fontWeight = 'bold'  title.style.color = '#ffffff'  title.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.5)'  title.style.textAlign = 'left'  title.style.marginLeft = '36px'  title.style.paddingTop = '7px'  title.style.transform = 'skewX(-10deg)'  titleArea.appendChild(title)  const dataArea = document.createElement('div')  dataArea.style.display = 'flex'  dataArea.style.flexDirection = 'column'  dataArea.style.alignItems = 'flex-start'  dataArea.style.gap = '8px'  dataArea.style.marginBottom = '16px'  const complaintsRow = document.createElement('div')  complaintsRow.style.display = 'grid'  complaintsRow.style.gridTemplateColumns = '74px auto 12px'  complaintsRow.style.columnGap = '6px'  complaintsRow.style.alignItems = 'baseline'  const complaintsLabel = document.createElement('span')  complaintsLabel.textContent = '客诉总量:'  complaintsLabel.style.cssText = 'color: #93c5fd; font-size: 14px; font-weight: 500; text-align:right;'  const complaintsValue = document.createElement('span')  complaintsValue.textContent = regionData.complaints  complaintsValue.style.cssText = 'color: rgb(232 255 255); font-size: 20px; font-weight: bold; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);'  const complaintsUnit = document.createElement('span')  complaintsUnit.textContent = '个'  complaintsUnit.style.cssText = 'color: #93c5fd; font-size: 12px;'  complaintsRow.appendChild(complaintsLabel)  complaintsRow.appendChild(complaintsValue)  complaintsRow.appendChild(complaintsUnit)  const percentageRow = document.createElement('div')  percentageRow.style.display = 'grid'  percentageRow.style.gridTemplateColumns = '74px auto 12px'  percentageRow.style.columnGap = '6px'  percentageRow.style.alignItems = 'baseline'  const percentageLabel = document.createElement('span')  percentageLabel.textContent = '占比:'  percentageLabel.style.cssText = 'color: #93c5fd; font-size: 14px; font-weight: 500; text-align:right;'  const percentageValue = document.createElement('span')  percentageValue.textContent = regionData.percentage  percentageValue.style.cssText = 'color: rgb(232 255 255); font-size: 20px; font-weight: bold; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);'  const percentageUnit = document.createElement('span')  percentageUnit.textContent = '%'  percentageUnit.style.cssText = 'color: #93c5fd; font-size: 12px;'  percentageRow.appendChild(percentageLabel)  percentageRow.appendChild(percentageValue)  percentageRow.appendChild(percentageUnit)    ; (popupContainer as any)._complaintsSpan = complaintsValue    ; (popupContainer as any)._percentageSpan = percentageValue  dataArea.appendChild(complaintsRow)  dataArea.appendChild(percentageRow)  const bottomSection = document.createElement('div')  bottomSection.style.display = 'flex'  bottomSection.style.justifyContent = 'center'  popupContainer.appendChild(titleArea)  popupContainer.appendChild(dataArea)  popupContainer.appendChild(bottomSection)  return popupContainer}const { scene, camera } = useThree(containerRef, {  controls: true,    light: true,       css2d: true,       bloom: false     })camera.position.set(-100, 400, 350);const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);directionalLight.position.set(100, 200, 100);directionalLight.castShadow = true;scene.add(directionalLight);const ambientLight = new THREE.AmbientLight(0x404040, 0.4);scene.add(ambientLight);scene.background = null;let map: anyconst loadModalImageSize = () => {  const img = new Image()  img.onload = () => {    modalImageSize = {      width: img.naturalWidth,      height: img.naturalHeight    }    console.log('弹框图片尺寸:', modalImageSize)  }  img.src = modalBg}onMounted(() => {  loadModalImageSize()  fetchRegionData()  fetch('/shengyang.json')    .then(res => res.json())    .then(shenyang => {      map = new THREEMAP(shenyang, {        scale: 13000,                                   center: [-123.406664, -41.788074],              texture: {          value: new THREE.TextureLoader().load(sy),            max: [123.814145, 43.042711],                         min: [122.422105, 41.199854]                        }      })      scene.add(map)      addClusterOutline(shenyang, ['康平县', '法库县'])      addClusterOutline(shenyang, ['新民市', '辽中区'])      addRegionLabels(scene)      map.initGUI(regionLabelObjects)      map.setPopupPositionUpdateCallback(updatePopupPosition)    })})let regionLabelObjects: CSS2DObject[] = []function addRegionLabels(scene: THREE.Scene) {  const color = '#efffff'  const regionLabels = [    { name: '康平县', position: [40, 35, -155], color },    { name: '法库县', position: [20, 35, -80], color },    { name: '新民市', position: [-50, 35, -10], color },    { name: '辽中区', position: [-70, 35, 110], color },    { name: '于洪区', position: [40, 35, 30], color },    { name: '沈北新区', position: [90, 35, -10], color },    { name: '大东区', position: [100, 35, 45], color },    { name: '和平区', position: [65, 35, 85], color },    { name: '苏家屯区', position: [50, 35, 110], color },    { name: '浑南区', position: [115, 35, 85], color },    { name: '沈河区', position: [90, 35, 76], color },    { name: '皇姑区', position: [80, 35, 50], color },    { name: '铁西区', position: [30, 35, 77], color }  ]  regionLabels.forEach(region => {    const containerDiv = document.createElement('div')    containerDiv.style.position = 'relative'    containerDiv.style.display = 'flex'    containerDiv.style.flexDirection = 'column'    containerDiv.style.alignItems = 'center'    containerDiv.style.userSelect = 'none'    const iconImg = document.createElement('img')    iconImg.src = maodian    iconImg.style.width = '20px'    iconImg.style.height = '20px'    iconImg.style.marginBottom = '2px'    iconImg.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.5))'    iconImg.style.display = 'block'    iconImg.style.margin = '0 auto 2px auto'    const labelContainer = document.createElement('div')    labelContainer.style.position = 'relative'    labelContainer.style.display = 'flex'    labelContainer.style.alignItems = 'center'    labelContainer.style.justifyContent = 'center'    labelContainer.style.minWidth = '60px'    labelContainer.style.height = '24px'    labelContainer.style.backgroundImage = `url(${bj})`    labelContainer.style.backgroundSize = '100% 100%'    labelContainer.style.backgroundRepeat = 'no-repeat'    labelContainer.style.backgroundPosition = 'center'    const labelText = document.createElement('div')    labelText.innerText = region.name    labelText.style.color = region.color    labelText.style.fontSize = '10px'    labelText.style.fontWeight = '300'    labelText.style.fontFamily = 'Arial, sans-serif'    labelText.style.whiteSpace = 'nowrap'    labelText.style.padding = '0 8px'    const popupEl = createPopupElement(region.name)    popupEl.style.display = 'none'    popupEl.style.position = 'absolute'    popupEl.style.left = '106px'    popupEl.style.bottom = 'calc(100% - 5px)'     popupEl.style.transform = 'translateX(-50%)'    containerDiv.appendChild(popupEl)    labelContainer.appendChild(labelText)    containerDiv.appendChild(iconImg)    containerDiv.appendChild(labelContainer)    const label = new CSS2DObject(containerDiv)    label.position.set(region.position[0], region.position[1], region.position[2])    label.userData = {      regionName: region.name,      originalPosition: [...region.position],      popupEl    }    scene.add(label)    regionLabelObjects.push(label)  })  startPopupRotation()}let rotationInterval: any = nullfunction startPopupRotation() {  if (rotationInterval) clearInterval(rotationInterval)  if (regionLabelObjects.length === 0) return  const sorted = [...regionLabelObjects].sort((a, b) => {    const dataA = getRegionData(a.userData.regionName)    const dataB = getRegionData(b.userData.regionName)    return parseInt(dataB.complaints) - parseInt(dataA.complaints)  })  let idx = 0  const showPopup = (index: number) => {    sorted.forEach(l => (l.userData.popupEl.style.display = 'none'))    const current = sorted[index]    if (current) current.userData.popupEl.style.display = 'block'  }  showPopup(idx)  rotationInterval = setInterval(() => {    idx = (idx + 1) % sorted.length    showPopup(idx)  }, 30000000)}function addClusterOutline(shenyangData: any, names: string[]) {  const projection = (map as any).projection as (lnglat: [number, number]) => [number, number]  const material = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2, depthTest: false })  const clusterGroup = new THREE.Group()  clusterGroup.name = names.join('-') + '-solid-outline'  const TOP_HEIGHT = 30.5   const edgeCount: Map<string, { p1: [number, number], p2: [number, number], count: number }> = new Map()  names.forEach((n) => {    const feature = shenyangData.features.find((f: any) => f.properties.name === n)    if (!feature) return    const polys: [number, number][][][] = feature.geometry.type === 'Polygon'      ? [feature.geometry.coordinates]      : feature.geometry.coordinates    polys.forEach((poly) => {      const exterior = poly[0]      for (let i = 0; i < exterior.length; i++) {        const a = exterior[i]        const b = exterior[(i + 1) % exterior.length]        const key = a[0] < b[0] || (a[0] === b[0] && a[1] < b[1])          ? `${a[0]},${a[1]}|${b[0]},${b[1]}`          : `${b[0]},${b[1]}|${a[0]},${a[1]}`        if (!edgeCount.has(key)) {          edgeCount.set(key, { p1: a as [number, number], p2: b as [number, number], count: 1 })        } else {          const obj = edgeCount.get(key)!          obj.count += 1        }      }    })  })  const outerPositions: number[] = []  edgeCount.forEach(({ p1, p2, count }) => {    if (count === 1) {      const [x1, y1] = projection(p1) as [number, number]      const [x2, y2] = projection(p2) as [number, number]      outerPositions.push(x1, -y1, TOP_HEIGHT)      outerPositions.push(x2, -y2, TOP_HEIGHT)    }  })  if (outerPositions.length > 0) {    const geometry = new THREE.BufferGeometry()    geometry.setAttribute('position', new THREE.Float32BufferAttribute(outerPositions, 3))    const lineSeg = new THREE.LineSegments(geometry, material)    clusterGroup.add(lineSeg)  }  map.add(clusterGroup)}const refreshAllPopupContent = () => {  regionLabelObjects.forEach(label => {    const regionName: string = label.userData.regionName    const data = getRegionData(regionName)    const popup = label.userData.popupEl as HTMLDivElement    if (!popup) return    const complaintsSpan = (popup as any)._complaintsSpan as HTMLSpanElement | undefined    const percentageSpan = (popup as any)._percentageSpan as HTMLSpanElement | undefined    if (complaintsSpan) complaintsSpan.textContent = data.complaints    if (percentageSpan) percentageSpan.textContent = data.percentage  })}</script>